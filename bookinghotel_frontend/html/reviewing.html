<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Đánh giá Homestay</title>
  <link rel="stylesheet" href="/css/PhieuDanhGia.css" />

</head>

<body>
  <div class="form-container">
    <h1>Đánh giá Homestay</h1>

    <label for="hotel-code">Mã khách sạn:</label>
    <input type="text" id="hotel-code" readonly />

    <label for="customer-code">Mã khách hàng:</label>
    <input type="text" id="customer-code" readonly />

    <label for="content">Nội dung:</label>
    <textarea id="content" required></textarea>

    <label for="score">Số điểm:</label>
    <input type="number" id="score" min="0" max="10" step="0.5" required />

    <button type="submit" id="submitBtn">Gửi</button>
  </div>

  <script src="/js/utils.js"></script>
  <script>
    const reviewApiUrl = "http://localhost:8080/api/v1/reviews";

    // --- Lấy dữ liệu khách sạn và khách hàng từ session/local storage ---
    const hotelCodeInput = document.getElementById("hotel-code");
    const customerCodeInput = document.getElementById("customer-code");

    const selectedHotelId = sessionStorage.getItem("selectedHotelId");
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const token = localStorage.getItem("access_token");

    // --- Kiểm tra nếu chưa chọn khách sạn hoặc chưa login ---
    if (!selectedHotelId) {
      alert("Bạn chưa chọn khách sạn! Chuyển về trang danh sách.");
      window.location.href = "home.html";
    }

    if (!token || !user.id) {
      alert("Bạn chưa đăng nhập! Chuyển về trang đăng nhập.");
      window.location.href = "login.html";
    }

    // --- Set giá trị input ---
    hotelCodeInput.value = selectedHotelId;
    customerCodeInput.value = user.id || "";

    // --- Gửi đánh giá ---
    document
      .getElementById("submitBtn")
      .addEventListener("click", async (e) => {
        e.preventDefault();

        const noiDung = document.getElementById("content").value.trim();
        const soDiem = parseFloat(document.getElementById("score").value);

        if (!noiDung || isNaN(soDiem)) {
          alert("Vui lòng nhập đầy đủ nội dung và điểm đánh giá.");
          return;
        }

        if (soDiem < 0 || soDiem > 10) {
          alert("Điểm đánh giá phải từ 0 đến 10!");
          return;
        }

        const reviewObj = {
          comment: noiDung,
          rating: soDiem,
          hotel_id: parseInt(selectedHotelId),
          user_id: user.id,
        };

        try {
          const res = await apiCall(reviewApiUrl, {
            method: "POST",
            body: JSON.stringify(reviewObj),
          });

          if (!res) {
            alert("Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại!");
            return;
          }

          const result = await res.json();

          if (!res.ok) {
            const errorMessage = result.message || "Không thể gửi đánh giá. Vui lòng thử lại!";
            alert(errorMessage);
            return;
          }

          alert("Đánh giá đã gửi thành công!");
          window.location.href = `detail.html?maKS=${selectedHotelId}`;
        } catch (err) {
          console.error(err);
          alert("Lỗi kết nối: " + err.message);
        }
      });
  </script>
</body>

</html>