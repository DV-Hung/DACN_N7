<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin AncientBooking</title>
  <script src="/js/utils.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="/css/Home_Admin.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2 class="text-center mb-4" style="font-size: 35px">
      Admin <br />AncientBooking
    </h2>
    <img src="/image/1admin.png" alt="Profile" class="rounded-circle mx-auto d-block mb-4" width="100" />
    <p class="text-center">AncientBooking</p>
    <ul class="nav flex-column">
      <li class="nav-item">
        <a class="nav-link" href="admin_hotel.html" onclick="logout()" style="font-size: 95%">
          <i class="fas fa-hotel"></i>Quản lý khách sạn<i class="fas fa-chevron-down-o"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="login.html" onclick="logout()" style="font-size: 95%">
          <i class="fas fa-sign-out-alt"></i>Đăng xuất<i class="fas fa-chevron-down-o"></i>
        </a>
      </li>
    </ul>
  </div>

  <!-- Content -->
  <div class="content">
    <nav class="navbar navbar-expand navbar-light bg-light">
      <button id="sidebarToggle" class="btn btn-outline-secondary mr-2" title="Toggle Sidebar">
        <i class="fas fa-bars"></i>
      </button>
      <a class="navbar-brand" href="admin.html">Home</a>
      <a class="navbar-brand" href="home.html">Website</a>
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="#"><i class="fas fa-comments"></i><span class="badge badge-danger">3</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#"><i class="fas fa-bell"></i><span class="badge badge-warning">15</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#"><i class="fas fa-th-large"></i></a>
        </li>
      </ul>
    </nav>
    <div class="container mt-4">
      <h2>Danh Sách Đơn Hàng</h2>
      <div class="orders-table-wrapper">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>Mã Khách Hàng</th>
              <th>Mã Phòng</th>
              <th>Tên Người Đặt</th>
              <th>Email</th>
              <th>SDT</th>
              <th>Ngày Nhận</th>
              <th>Ngày Trả</th>
              <th>Tổng Chi Phí(VND)</th>

            </tr>
          </thead>
          <tbody>
            <!-- Dữ liệu sẽ load bằng JS -->
          </tbody>
        </table>
        <div id="ordersPagination"
          style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px"></div>
      </div>
    </div>
    <script>
      // Đồng nhất hostname
      if (window.location.hostname === "localhost") {
        window.location.replace(
          window.location.href.replace("localhost", "127.0.0.1")
        );
      }
    </script>

    <script>
      const hoaDonApiUrl = "http://localhost:8080/api/v1/bills";

      // pagination state
      let ordersCurrentPage = 1;
      let ordersPageSize = 20;

      // Hàm hủy booking
      async function cancelBooking(billId) {
        if (!confirm(`Bạn có chắc chắn muốn hủy đặt phòng này?`))
          return;

        try {
          const res = await apiCall(
            `${hoaDonApiUrl}/${billId}`,
            {
              method: "DELETE",
            }
          );

          if (res) {
            alert("Đã hủy đặt phòng thành công!");
            loadOrders();
          }
        } catch (err) {
          console.error(err);
          alert("Không thể hủy đặt phòng. Vui lòng thử lại!");
        }
      }

      // Hàm load danh sách đơn hàng (supports pagination)
      async function loadOrders(page = 1, pageSize = ordersPageSize) {
        try {
          ordersCurrentPage = page;
          ordersPageSize = pageSize;
          // Convert to 0-based page for backend (Spring Data uses 0-based pagination)
          const backendPage = page - 1;
          const url = `${hoaDonApiUrl}?page=${backendPage}&size=${pageSize}`;
          const res = await apiCall(url);
          if (!res) return;
          const result = await res.json();
          const meta = result.data?.meta || { page: 1, pageSize: pageSize, pages: 1, total: 0 };
          const orders = result.data?.result || [];

          const tbody = document.querySelector("#ordersTable tbody");
          tbody.innerHTML = "";

          orders.forEach((order) => {
            const tr = document.createElement("tr");
            // adapt fields from backend response
            tr.innerHTML = `
          <td>${order.user?.id || (order.user?.id) || 'N/A'}</td>
          <td>${order.room?.id || (order.roomId) || 'N/A'}</td>
          <td>${order.username || order.user?.username || 'N/A'}</td>
          <td>${order.email || order.user?.email || 'N/A'}</td>
          <td>${order.phoneNumber || order.user?.phoneNumber || order.user?.phone || 'N/A'}</td>
          <td>${order.checkInDate ? new Date(order.checkInDate).toLocaleDateString() : (order.checkIn ? new Date(order.checkIn).toLocaleDateString() : 'N/A')}</td>
          <td>${order.checkOutDate ? new Date(order.checkOutDate).toLocaleDateString() : (order.checkOut ? new Date(order.checkOut).toLocaleDateString() : 'N/A')}</td>
          <td>${(order.totalCost || order.totalPrice) ? parseInt(order.totalCost || order.totalPrice).toLocaleString() : 0}</td>
          
        `;
            tbody.appendChild(tr);
          });

          renderOrdersPagination(meta);
        } catch (err) {
          console.error(err);
          alert("Không thể tải danh sách đơn hàng!");
        }
      }

      // Use generic renderPagination from utils.js
      function renderOrdersPagination(meta) {
        renderPagination('ordersPagination', meta, loadOrders);
      }

      // Load danh sách khi trang load xong (wrap to avoid event being passed)
      window.addEventListener("load", () => loadOrders());
    </script>

    <div class="container mt-4">

      <body>
        <h2>Danh Sách Người Dùng</h2>
        <div class="table-container">
          <table id="userTable">
            <thead>
              <tr>
                <th>Mã Khách hàng</th>
                <th>Tên Tài Khoản</th>
                <th>Email</th>
                <th>SDT</th>
                <th>Ngày Tạo</th>
              </tr>
            </thead>
            <tbody>
              <!-- Dữ liệu sẽ được load bằng JS -->
            </tbody>
          </table>
          <div id="usersPagination"
            style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px"></div>
        </div>

        <script>
          const usersApiUrl = "http://localhost:8080/api/v1/users";

          // pagination state for users
          let usersCurrentPage = 1;
          let usersPageSize = 20;

          async function loadUsers(page = 1, pageSize = usersPageSize) {
            try {
              usersCurrentPage = page;
              usersPageSize = pageSize;
              // Convert to 0-based page for backend (Spring Data uses 0-based pagination)
              const backendPage = page - 1;
              const url = `${usersApiUrl}?page=${backendPage}&size=${pageSize}`;
              const res = await apiCall(url);
              if (!res) return;
              const result = await res.json();
              const meta = result.data?.meta || { page: 1, pageSize: pageSize, pages: 1, total: 0 };
              const users = result.data?.result || [];

              const tbody = document.querySelector("#userTable tbody");
              tbody.innerHTML = "";

              users.forEach((user) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.userName || 'N/A'}</td>
            <td>${user.email}</td>
            <td>${user.phoneNumber || 'N/A'}</td>
            <td>${new Date(user.createAt).toLocaleDateString()}</td>
           
          `;
                tbody.appendChild(tr);
              });

              renderUsersPagination(meta);
            } catch (err) {
              console.error(err);
              alert("Không thể tải danh sách người dùng.");
            }
          }

          // Use generic renderPagination from utils.js
          function renderUsersPagination(meta) {
            renderPagination('usersPagination', meta, loadUsers);
          }

        </script>
      </body>
    </div>

    <div class="container mt-4">
      <body2>
        <div class="container py-5" style="margin-top: -5%">
          <h2 class="mb-4">Thống kê - AncientBooking.com</h2>
          <div class="row">
            <div class="col-md-3">
              <div class="widget-box bg-primary-custom shadow">
                <div>
                  <h4 id="donHang">0</h4>
                  <p>Đơn hàng</p>
                </div>
                <i class="fas fa-shopping-cart icon"></i>
              </div>
            </div>
            <div class="col-md-3">
              <div class="widget-box bg-green shadow">
                <div>
                  <h4 id="soDanhGia">0</h4>
                  <p>Số lượt đánh giá</p>
                </div>
                <i class="fas fa-star icon"></i>
              </div>
            </div>
            <div class="col-md-3">
              <div class="widget-box bg-yellow shadow">
                <div>
                  <h4 id="nguoiDung">0</h4>
                  <p>Người dùng hiện tại</p>
                </div>
                <i class="fas fa-user-plus icon"></i>
              </div>
            </div>
            <div class="col-md-3">
              <div class="widget-box bg-red shadow">
                <div>
                  <h4 id="phongTrong">0</h4>
                  <p>Số phòng còn trống</p>
                </div>
                <i class="fas fa-door-open icon"></i>
              </div>
            </div>
          </div>
        </div>
        <script>
          const apiBase = "http://localhost:8080/api/v1";

          // Shared count data for widgets and chart
          const countData = {
            bills: 0,
            reviews: 0,
            users: 0,
            rooms: 0
          };

          // Function to render widgets from the shared data
          function renderWidgets() {
            document.getElementById("donHang").innerText = countData.bills;
            document.getElementById("soDanhGia").innerText = countData.reviews;
            document.getElementById("nguoiDung").innerText = countData.users;
            document.getElementById("phongTrong").innerText = countData.rooms;
          }

          // Function to render the chart from the shared data
          function renderChart() {
            const ctx = document.getElementById("widgetsChart").getContext("2d");
            new Chart(ctx, {
              type: "bar",
              data: {
                labels: ["Đơn hàng", "Đánh giá", "Người dùng", "Phòng trống"],
                datasets: [{
                  label: "Số lượng",
                  data: [countData.bills, countData.reviews, countData.users, countData.rooms],
                  backgroundColor: ["#41a413", "#db4e12", "#1f35df", "#5911c5"],
                  borderWidth: 1,
                },],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: false
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true
                  },
                },
              },
            });
          }

          // Single function to load all dashboard stats
          async function loadDashboardStats() {
            try {
              const [billsRes, reviewsRes, usersRes, roomsRes] = await Promise.all([
                apiCall(`${apiBase}/bills/count`),
                apiCall(`${apiBase}/reviews/count`),
                apiCall(`${apiBase}/users/count`),
                apiCall(`${apiBase}/rooms/count`),
              ]);

              // Check for null responses (e.g., token expired)
              if (!billsRes || !reviewsRes || !usersRes || !roomsRes) {
                console.warn("Could not fetch all count data. Some widgets/chart data may be missing.");
                return;
              }

              const billsData = await billsRes.json();
              const reviewsData = await reviewsRes.json();
              const usersData = await usersRes.json();
              const roomsData = await roomsRes.json();

              countData.bills = billsData.data || 0;
              countData.reviews = reviewsData.data || 0;
              countData.users = usersData.data || 0;
              countData.rooms = roomsData.data || 0;

              // Render both widgets and chart with the fetched data
              renderWidgets();
              renderChart();

            } catch (err) {
              console.error("Error loading dashboard stats:", err);
            }
          }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      </body2>
    </div>
    <div class="card mt-4" style="width: 80%; margin-left: 10%">
      <div class="card-body">
        <h5 class="card-title text-center">Thống kê tổng quan</h5>
        <canvas id="widgetsChart" height="120"></canvas>
      </div>
    </div>
    <div class="footer">
      <p>Copyright © 2014-2021 AdminLTE.io. All rights reserved.</p>
      <p>Version 3.2.0-rc</p>
    </div>
  </div>
  <script>
    window.addEventListener("load", () => {
      loadOrders();
      loadUsers();
      loadDashboardStats();
    });
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>